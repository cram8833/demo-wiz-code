name: Deploy

on:
  workflow_run:
    workflows: ["Build Image"]
    types: [completed]

permissions:
  id-token: write
  contents: read

jobs:
  deploy-to-prod:
    # On ne déploie QUE si le build a réussi ET que c'est sur la branche main
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest

    steps:
      # 1. Connexion Azure OIDC
      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 2. Récupération du SHA du commit qui a déclenché le build
      # (Puisque c'est un nouveau workflow, on doit retrouver le tag utilisé)
      - name: Get Image Tag
        run: echo "DEPLOY_TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV

      # 3. Déploiement sur le service CaaS (App Service / Web App)
      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'sagesse-dev-cram8833'
          images: '${{ secrets.ACR_NAME }}.azurecr.io/sagesse-dev:${{ env.DEPLOY_TAG }}'

      # 4. Vérification du Health Check (Optionnel via CLI)
      - name: Verify Deployment
        run: |
          echo "Vérification du démarrage de l'application..."
          sleep 30
          curl -f http://sagesse-dev-cram8833.azurewebsites.net/ || exit 1